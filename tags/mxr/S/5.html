<html>
<head>
<title>kernel/arch/i386/cpu/gdt.c</title>
<meta name='robots' content='noindex,nofollow'>
<meta name='generator' content='GLOBAL-5.5'>
</head>
<body text='#191970' bgcolor='#f5f5dc' vlink='gray'>
<a name='TOP'><h2><a href='../mains.html'>root</a>/<a href='../files/47.html'>kernel</a>/<a href='../files/48.html'>arch</a>/<a href='../files/49.html'>i386</a>/<a href='../files/51.html'>cpu</a>/gdt.c</h2>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L104'>[^]</a><a href='#L168'>[v]</a>[top]<a href='#BOTTOM'>[bottom]</a><a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
<hr>
<h2>DEFINITIONS</h2>
This source file includes following definitions.
<ol>
<li><a href='#L104' title='Defined at 104.'>i386_gdt_edit</a>
<li><a href='#L130' title='Defined at 130.'>i386_gdt_load</a>
<li><a href='#L146' title='Defined at 146.'>i386_gdt_init</a>
<li><a href='#L168' title='Defined at 168.'>i386_gdt_tss</a>
</ol>
<hr>
<pre>
<a name='L1'><i><font color='green'>/*****************************************************************************</font></i>
<a name='L2'><i><font color='green'> * Micron System V3 - I386 Architecture Driver</font></i>
<a name='L3'><i><font color='green'> * Copyright (C) 2007, Micron System Team</font></i>
<a name='L4'><i><font color='green'> * Copyright (C) 2007, Martin Tang</font></i>
<a name='L5'><i><font color='green'> * PROTECTED UNDER MICRON SYSTEM PUBLIC LICENSE AGREEMENT.</font></i>
<a name='L6'><i><font color='green'> *****************************************************************************</font></i>
<a name='L7'><i><font color='green'> * Design Notes:</font></i>
<a name='L8'><i><font color='green'> *     This is the I386 GDT manager, providing a standard controling interface</font></i>
<a name='L9'><i><font color='green'> *   to I386 processor memory management segment subsystem.</font></i>
<a name='L10'><i><font color='green'> *</font></i>
<a name='L11'><i><font color='green'> * GDT Entries:</font></i>
<a name='L12'><i><font color='green'> *   1. Null entry</font></i>
<a name='L13'><i><font color='green'> *   2. Kernel code segment</font></i>
<a name='L14'><i><font color='green'> *   3. Kernel data segment</font></i>
<a name='L15'><i><font color='green'> *   4. V8086 code segment</font></i>
<a name='L16'><i><font color='green'> *   5. V8086 data segment</font></i>
<a name='L17'><i><font color='green'> *   6. Application code segment</font></i>
<a name='L18'><i><font color='green'> *   7. Application data segment</font></i>
<a name='L19'><i><font color='green'> *   8. Task switch selector(TSS) segment</font></i>
<a name='L20'><i><font color='green'> *</font></i>
<a name='L21'><i><font color='green'> * Developer Reference:</font></i>
<a name='L22'><i><font color='green'> *   1. IA-32 Intel Architecture Software Developer's Manual, Volume 3</font></i>
<a name='L23'><i><font color='green'> *****************************************************************************/</font></i>
<a name='L24'>
<a name='L25'><font color='darkred'>#define</font> <a href='../R/9.html' title='Multiple refered from 2 places.'>GDT_ENTRIES</a> 8
<a name='L26'>
<a name='L27'><b>struct</b> i386_gdt
<a name='L28'><font color='red'>{</font>
<a name='L29'>        <b>unsigned</b> slim_l:16;     <i><font color='green'>/* segment limit 15..0 */</font></i>
<a name='L30'>        <b>unsigned</b> badd_l:16;     <i><font color='green'>/* base address 15..0 */</font></i>
<a name='L31'>        <b>unsigned</b> badd_m:8;      <i><font color='green'>/* base address 23..16 */</font></i>
<a name='L32'>        <b>unsigned</b> type:5;        <i><font color='green'>/* segment type */</font></i>
<a name='L33'>        <b>unsigned</b> dpl:2;         <i><font color='green'>/* descriptor privilege level */</font></i>
<a name='L34'>        <b>unsigned</b> p:1;           <i><font color='green'>/* segment present */</font></i>
<a name='L35'>        <b>unsigned</b> slim_h:4;      <i><font color='green'>/* segment limit 19..16 */</font></i>
<a name='L36'>        <b>unsigned</b> avl:1;         <i><font color='green'>/* available for use by system software */</font></i>
<a name='L37'>        <b>unsigned</b> l:1;           <i><font color='green'>/* 64bit code segment */</font></i>
<a name='L38'>        <b>unsigned</b> db:1;          <i><font color='green'>/* default operation syze */</font></i>
<a name='L39'>        <b>unsigned</b> g:1;           <i><font color='green'>/* granularity */</font></i>
<a name='L40'>        <b>unsigned</b> badd_h:8;      <i><font color='green'>/* base address 31..24 */</font></i>
<a name='L41'><font color='red'>}</font><b>__attribute__</b>((packed)) i386_gdt[<a href='../S/5.html#L25' title='Defined at 25 in kernel/arch/i386/cpu/gdt.c.'>GDT_ENTRIES</a>];
<a name='L42'>
<a name='L43'><b>struct</b> i386_gdtr
<a name='L44'><font color='red'>{</font>
<a name='L45'>        <b>unsigned</b> limit:16;
<a name='L46'>        <b>unsigned</b> base:32;
<a name='L47'><font color='red'>}</font><b>__attribute__</b>((packed)) i386_gdtr;
<a name='L48'>
<a name='L49'><b>enum</b> i386_gdt_s
<a name='L50'><font color='red'>{</font>
<a name='L51'>        SYSTEM,                 <i><font color='green'>/* system segment */</font></i>
<a name='L52'>        CODE_DATA               <i><font color='green'>/* code or data */</font></i>
<a name='L53'><font color='red'>}</font>;
<a name='L54'>
<a name='L55'><b>enum</b> i386_gdt_db
<a name='L56'><font color='red'>{</font>
<a name='L57'>        BITS16,                 <i><font color='green'>/* 16 bit segment */</font></i>
<a name='L58'>        BITS32                  <i><font color='green'>/* 32 bit segment */</font></i>
<a name='L59'><font color='red'>}</font>;
<a name='L60'>
<a name='L61'><b>enum</b> i386_gdt_gran
<a name='L62'><font color='red'>{</font>
<a name='L63'>        UNIT_1B,                <i><font color='green'>/* segment limit in 1byte unit */</font></i>
<a name='L64'>        UNIT_4K                 <i><font color='green'>/* segment limit in 4KB unit */</font></i>
<a name='L65'><font color='red'>}</font>;
<a name='L66'>
<a name='L67'><b>enum</b> i386_gdt_type
<a name='L68'><font color='red'>{</font>
<a name='L69'>        SYST_RES0,
<a name='L70'>        SYST_BITS16_TSS_AVAL,
<a name='L71'>        SYST_LDT,
<a name='L72'>        SYST_BITS16_TSS_BUSY,
<a name='L73'>        SYST_BITS16_CAL_GATE,
<a name='L74'>        SYST_TASK_GATE,
<a name='L75'>        SYST_BITS16_INT_GATE,
<a name='L76'>        SYST_BITS16_TRP_GATE,
<a name='L77'>        SYST_RES1,
<a name='L78'>        SYST_BITS32_TSS_AVAL,
<a name='L79'>        SYST_RES2,
<a name='L80'>        SYST_BITS32_TSS_BUSY,
<a name='L81'>        SYST_BITS32_CAL_GATE,
<a name='L82'>        SYST_RES3,
<a name='L83'>        SYST_BITS32_INT_GATE,
<a name='L84'>        SYST_BITS32_TRP_GATE,
<a name='L85'>        DATA_READ,
<a name='L86'>        DATA_READ_ACCESSED,
<a name='L87'>        DATA_READ_WRITE,
<a name='L88'>        DATA_READ_WRITE_ACCESSED,
<a name='L89'>        DATA_READ_EXP,
<a name='L90'>        DATA_READ_EXP_ACCESSED,
<a name='L91'>        DATA_READ_WRITE_EXP,
<a name='L92'>        DATA_READ_WRITE_EXP_ACCESSED,
<a name='L93'>        CODE_EXEC,
<a name='L94'>        CODE_EXEC_ACCESSED,
<a name='L95'>        CODE_READ_EXEC,
<a name='L96'>        CODE_READ_EXEC_ACCESSED,
<a name='L97'>        CODE_EXEC_CONFORM,
<a name='L98'>        CODE_EXEC_CONFORM_ACCESSED,
<a name='L99'>        CODE_READ_EXEC_CONFORM,
<a name='L100'>        CODE_READ_EXEC_CONFORM_ACCESSED
<a name='L101'><font color='red'>}</font>;
<a name='L102'>
<a name='L103'><i><font color='green'>/* GDT entry modifier */</font></i>
<a name='L104'><b>int</b> <a href='../R/44.html' title='Multiple refered from 8 places.'>i386_gdt_edit</a>(<b>unsigned</b> index,               <i><font color='green'>/* GDT Index */</font></i>
<a name='L105'>                  <b>unsigned</b> address,             <i><font color='green'>/* segment address */</font></i>
<a name='L106'>                  <b>unsigned</b> limit,               <i><font color='green'>/* segment limit */</font></i>
<a name='L107'>                  <b>unsigned</b> present,             <i><font color='green'>/* segment present */</font></i>
<a name='L108'>                  <b>unsigned</b> dpl,                 <i><font color='green'>/* descriptor privilege */</font></i>
<a name='L109'>                  <b>enum</b> i386_gdt_db   db,        <i><font color='green'>/* default data length */</font></i>
<a name='L110'>                  <b>enum</b> i386_gdt_type type,      <i><font color='green'>/* descriptor type */</font></i>
<a name='L111'>                  <b>enum</b> i386_gdt_gran gran)      <i><font color='green'>/* data granularity */</font></i>
<a name='L112'><font color='red'>{</font>
<a name='L113'>        <b>if</b>(index &gt; <a href='../S/5.html#L25' title='Defined at 25 in kernel/arch/i386/cpu/gdt.c.'>GDT_ENTRIES</a>)
<a name='L114'>                <b>return</b> -1;                      <i><font color='green'>/* no such GDT entry */</font></i>
<a name='L115'>        i386_gdt[index].slim_l = limit &amp; 0xFFFF;
<a name='L116'>        i386_gdt[index].slim_h = (limit&gt;&gt;16) &amp; 0xF;
<a name='L117'>        i386_gdt[index].badd_l = address &amp; 0xFFFF;
<a name='L118'>        i386_gdt[index].badd_m = (address&gt;&gt;16) &amp; 0xFF;
<a name='L119'>        i386_gdt[index].badd_h = (address&gt;&gt;24) &amp; 0xFF;
<a name='L120'>        i386_gdt[index].p      = present;
<a name='L121'>        i386_gdt[index].dpl    = dpl;
<a name='L122'>        i386_gdt[index].db     = db;
<a name='L123'>        i386_gdt[index].type   = type;
<a name='L124'>        i386_gdt[index].g      = gran;
<a name='L125'>        i386_gdt[index].l      = 0;
<a name='L126'>        i386_gdt[index].avl    = 0;
<a name='L127'>        <b>return</b> 0;
<a name='L128'><font color='red'>}</font>
<a name='L129'>
<a name='L130'><b>void</b> <a href='../S/5.html#L164' title='Refered from 164 in kernel/arch/i386/cpu/gdt.c.'>i386_gdt_load</a>()
<a name='L131'><font color='red'>{</font>
<a name='L132'>        i386_gdtr.base = (<b>unsigned</b>)&amp;i386_gdt;
<a name='L133'>        i386_gdtr.limit= <b>sizeof</b>(i386_gdt) - 1;
<a name='L134'>        <b>asm</b>("lgdt i386_gdtr");
<a name='L135'>        <b>asm</b>("movw $0x10, %ax");
<a name='L136'>        <b>asm</b>("movw %ax,   %ss");
<a name='L137'>        <b>asm</b>("movw %ax,   %ds");
<a name='L138'>        <b>asm</b>("movw %ax,   %es");
<a name='L139'>        <b>asm</b>("movw %ax,   %fs");
<a name='L140'>        <b>asm</b>("movw %ax,   %gs");
<a name='L141'>        <b>asm</b>("ljmp $0x08, $newgdt");
<a name='L142'>        <b>asm</b>("newgdt:");
<a name='L143'><font color='red'>}</font>
<a name='L144'>
<a name='L145'><i><font color='green'>/* GDT manager initialization */</font></i>
<a name='L146'><b>void</b> i386_gdt_init()
<a name='L147'><font color='red'>{</font>
<a name='L148'>        <i><font color='green'>/* Null GDT entry */</font></i>
<a name='L149'>        <a href='../S/5.html#L104' title='Defined at 104 in kernel/arch/i386/cpu/gdt.c.'>i386_gdt_edit</a>(0,0,0,0,0,0,0,0);
<a name='L150'>
<a name='L151'>        <i><font color='green'>/* Kernel segments */</font></i>
<a name='L152'>        <a href='../S/5.html#L104' title='Defined at 104 in kernel/arch/i386/cpu/gdt.c.'>i386_gdt_edit</a>(1,0,0xFFFFF,1,0,BITS32,CODE_READ_EXEC_CONFORM,UNIT_4K);
<a name='L153'>        <a href='../S/5.html#L104' title='Defined at 104 in kernel/arch/i386/cpu/gdt.c.'>i386_gdt_edit</a>(2,0,0xFFFFF,1,0,BITS32,DATA_READ_WRITE,UNIT_4K);
<a name='L154'>
<a name='L155'>        <i><font color='green'>/* V8086 segments */</font></i>
<a name='L156'>        <a href='../S/5.html#L104' title='Defined at 104 in kernel/arch/i386/cpu/gdt.c.'>i386_gdt_edit</a>(3,0,0xFFFFF,1,0,BITS16,CODE_READ_EXEC_CONFORM,UNIT_1B);
<a name='L157'>        <a href='../S/5.html#L104' title='Defined at 104 in kernel/arch/i386/cpu/gdt.c.'>i386_gdt_edit</a>(4,0,0xFFFFF,1,0,BITS16,DATA_READ_WRITE,UNIT_1B);
<a name='L158'>
<a name='L159'>        <i><font color='green'>/* Application segments */</font></i>
<a name='L160'>        <a href='../S/5.html#L104' title='Defined at 104 in kernel/arch/i386/cpu/gdt.c.'>i386_gdt_edit</a>(5,0,0xFFFFF,1,3,BITS32,CODE_READ_EXEC_CONFORM,UNIT_4K);
<a name='L161'>        <a href='../S/5.html#L104' title='Defined at 104 in kernel/arch/i386/cpu/gdt.c.'>i386_gdt_edit</a>(6,0,0xFFFFF,1,3,BITS32,DATA_READ_WRITE,UNIT_4K);
<a name='L162'>
<a name='L163'>        <i><font color='green'>/* Load new GDT */</font></i>
<a name='L164'>        <a href='../S/5.html#L130' title='Defined at 130 in kernel/arch/i386/cpu/gdt.c.'>i386_gdt_load</a>();
<a name='L165'><font color='red'>}</font>
<a name='L166'>
<a name='L167'><i><font color='green'>/* Install a TSS to segment */</font></i>
<a name='L168'><b>void</b> <a href='../S/21.html#L10' title='Refered from 10 in kernel/include/arch-i386/gdt.h.'>i386_gdt_tss</a>(<b>unsigned</b> tadd, <b>unsigned</b> size)
<a name='L169'><font color='red'>{</font>
<a name='L170'>        <a href='../S/5.html#L104' title='Defined at 104 in kernel/arch/i386/cpu/gdt.c.'>i386_gdt_edit</a>(7,tadd,size,1,0,BITS32,SYST_BITS32_TSS_AVAL,UNIT_1B);
<a name='L171'><font color='red'>}</font>
<a name='L172'>
</pre>
<hr>
<a name='BOTTOM'>
<i><font color='green'>/* [&lt;][&gt;]<a href='#L104'>[^]</a><a href='#L168'>[v]</a><a href='#TOP'>[top]</a>[bottom]<a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</font></i>
</body>
</html>
